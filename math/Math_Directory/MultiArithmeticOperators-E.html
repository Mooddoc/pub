<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Existing head content -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://ez42.live/global/analytics.js"></script>
    <script src="https://ez42.live/global/ads.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tsparticles/confetti@3.0.3/tsparticles.confetti.bundle.min.js"></script>
    <link rel="stylesheet" href="http://www.ez42.live/global/styles/styles-eng.css">
    <link rel="icon" type="image/svg+xml" href="http://www.ez42.live/global/styles/ez42-icon.svg">
    <title>‚úÖ EZ42 LIVE - It's EZ</title>
    <!-- Include additional styles to adjust the game elements to match the template's design -->
    <style>
        /* Adjusted styles for the game elements */
        .game-area {
            background-color: white;
            border-radius: 0.625rem;
            padding: 1rem;
            box-shadow: 0 0.125rem 0.625rem rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 0;
            transition: flex 0.3s ease;
            min-height: 800px;
        }
        .options {
            background-color: #00acc1;
            color: white;
            border-radius: 0.625rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .option-item, .operator-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .options label {
            font-size: 1rem;
        }
        .options input[type="number"] {
            width: 80px;
            padding: 5px;
            border: none;
            border-bottom: 2px solid white;
            background-color: transparent;
            color: white;
            outline: none;
            text-align: center;
            font-size: 1rem;
        }
        .operator-btn {
            background-color: #0097a7;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.3125rem;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.1s;
        }
        .operator-btn.selected {
            background-color: #ff7f50;
        }
        .generate-btn {
            background-color: #ff7f50; /* Orange background */
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.3125rem;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 0.5rem;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .generate-btn:hover {
            background-color: #ff5722; /* Darker orange on hover */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .check-btn {
            background-color: #00acc1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.3125rem;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 0.5rem;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .check-btn:hover {
            background-color: #0097a7;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .exercise-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .exercise {
            background-color: rgba(224, 247, 250, 0.8);
            border-radius: 0.625rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            position: relative;
            transition: all 0.3s ease;
        }
        .exercise:hover {
            transform: translateY(-5px);
        }
        .whole-number, .operator {
            margin: 0 0.2rem;
            color: #ff7f50;
        }
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 0.2rem;
            color: #ff7f50;
        }
        .fraction .numerator {
            display: block;
            border-bottom: 2px solid #ff7f50;
        }
        .fraction .denominator {
            display: block;
        }
        .answer-area {
            width: 90px; /* 10% larger than .answer */
            height: 70px;  /* Maintain aspect ratio */
            border: 3px dashed #00acc1;
            background-color: #f0f0f0;
            border-radius: 0.3125rem;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin-left: 0.5rem;
        }
        .cloud {
            background-color: #e3f2fd;
            border-radius: 0.625rem;
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
        }
        .answer {
            width: 80px; /* 10% smaller than .answer-area */
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0.5rem;
            background-color: #ffffff;
            border: 2px solid #00acc1;
            border-radius: 0.3125rem;
            cursor: move;
            user-select: none;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }
        .answer:hover {
            transform: scale(1.05);
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .feedback {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.5rem;
        }
        .correct {
            color: #4caf50;
        }
        .incorrect {
            color: #f44336;
        }
        /* Progress Bar Styles */
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 25px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-bar {
            height: 20px;
            width: 0%;
            background-color: #76c7c0;
            text-align: center;
            line-height: 20px;
            color: white;
            transition: width 0.3s ease;
        }
        /* Stage Number Styles */
        .stage-number {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="content-wrapper">

            <!-- Side Panel 1 -->
            <div id="sidePanel1" class="side-panel">
                <div class="logo-container">
                    <a href="http://ez42.live" target="_blank" rel="noopener noreferrer">
                        <img src="http://ez42.live/global/logo/logo.svg" alt="EZ42 Logo" class="logo-image">
                    </a>
                </div>
                <h2>Instructions & Rules</h2>
                <ul>
                    <li>Select the number range and operators you want to practice.</li>
                    <li>Click "Generate" to create new exercises.</li>
                    <li>Drag and drop the correct answers from the blue bar to the exercise boxes.</li>
                    <li>You can move answers between boxes or back to the blue bar.</li>
                    <li>Click "Check Answers" when you're done to see how you did!</li>
                    <li>You must answer all questions correctly to proceed to the next stage.</li>
                    <li>There are 20 stages, each with 12 questions.</li>
                    <li>Have fun!</li>
                </ul>
            </div>

            <!-- Quiz Panel -->
            <div id="quizContainer" class="quiz-container">
                <h1>üåà Fun Math Exercises üåà</h1>

                <div id="switchContainer" class="switch-container">
                    <div id="multiStateSwitch" class="switch">
                        <div class="switch-labels"></div>
                        <div class="switch-handle"></div>
                    </div>
                </div>
                <div id="tabContent"></div>
            </div>

            <!-- Side Panel 2 -->
            <div id="sidePanel2" class="side-panel">
                <h2>Animal Farm</h2>
                <p>Watch your farm grow as you progress! Each completed stage adds new animal friends to your collection.</p>
                <ul id="animalFarm" class="emoji-list">
                </ul>
            </div>
        </div>
    </div>
    <div id="copyright-container"></div>

    <!-- Modal -->
    <div id="quizModal" class="modal-quiz">
        <div class="modal-quiz-content">
            <span class="modal-quiz-close">&times;</span>
            <p id="modalMessage"></p>
            <button id="modalButton" class="modal-quiz-button">OK</button>
        </div>
    </div>

    <script>
	// NewCalculusOperators-2.html?min=500&max=2000&operators=PL,MI,AS,DE  PL=(+) MI=(-) AS=(*) DE=(/)
        let isQuizExpanded = false;
        let allowQuizExpansion = true;

        let attempts = 0;
        let currentStage = 0;

        const manuallySetDefaultTab = 0; 

        const stageCount = 20; 

        const stateContents = {
            //'URL Parameters': `   '<div class="page-container">         <div class="content-wrapper">             <!-- Side Panel (Optional: Use if you want navigation or additional info) -->             <div class="side-panel">                 <h2>üìö How to Use URL Parameters</h2>                 <ul>                     <li><a href="#overview">Overview</a></li>                     <li><a href="#parameters">URL Parameters</a></li>                     <li><a href="#examples">Examples</a></li>                     <li><a href="#troubleshooting">Troubleshooting</a></li>                 </ul>             </div>             <!-- Main Content Area -->             <div class="quiz-container">                 <h1>üîß Customize Your Math Exercises</h1>                 <!-- Overview Section -->                 <section id="overview">                     <h2>üìå What Are URL Parameters?</h2>                     <p>URL parameters are special codes added to the web address (URL) that allow you to customize the behavior of a webpage. In the context of our math exercise game, these parameters let you adjust settings such as the range of numbers used in exercises and the types of mathematical operations you want to practice.</p>                 </section>                 <!-- Parameters Section -->                 <section id="parameters">                     <h2>üî¢ Available URL Parameters</h2>                     <p>There are three main parameters you can adjust:</p>                     <ul>                         <li><strong>Minimum Number (<code>min</code>):</strong> Sets the lowest number that will appear in your exercises.</li>                         <li><strong>Maximum Number (<code>max</code>):</strong> Sets the highest number that will appear in your exercises.</li>                         <li><strong>Operators (<code>operators</code>):</strong> Chooses which mathematical operations you'll practice.</li>                     </ul>                     <h3>üî† Operator Codes</h3>                     <p>To specify which mathematical operations you want to include, use the following custom codes:</p>                     <table>                         <thead>                             <tr>                                 <th>Operator</th>                                 <th>Symbol</th>                                 <th>Code</th>                             </tr>                         </thead>                         <tbody>                             <tr>                                 <td>Addition</td>                                 <td>+</td>                                 <td><strong>PL</strong></td>                             </tr>                             <tr>                                 <td>Subtraction</td>                                 <td>-</td>                                 <td><strong>MI</strong></td>                             </tr>                             <tr>                                 <td>Multiplication</td>                                 <td>√ó</td>                                 <td><strong>AS</strong></td>                             </tr>                             <tr>                                 <td>Division</td>                                 <td>√∑</td>                                 <td><strong>DE</strong></td>                             </tr>                         </tbody>                     </table>                     <p><em>Note:</em> If you omit the <code>operators</code> parameter, the game will default to using Addition (+) and Subtraction (-).</p>                 </section>                 <!-- Examples Section -->                 <section id="examples">                     <h2>üìö Example URLs</h2>                                         <h3>üéØ Setting the Minimum and Maximum Numbers</h3>                     <p>Use the <code>min</code> and <code>max</code> parameters to define the range of numbers in your exercises.</p>                     <ul>                         <li><strong>Minimum Number (<code>min</code>):</strong> Any whole number equal to or greater than 0.</li>                         <li><strong>Maximum Number (<code>max</code>):</strong> Any whole number greater than 0 and less than 10,000.</li>                     </ul>                                         <p><strong>Example:</strong> To set the minimum number to <code>500</code> and the maximum number to <code>2000</code>, add the following to the URL:</p>                     <div class="word-bubble">                         <code>?min=500&amp;max=2000</code>                     </div>                     <h3>üîß Selecting Mathematical Operators</h3>                     <p>Choose which operations you want to practice by using the <code>operators</code> parameter with the corresponding codes.</p>                                         <p><strong>Example:</strong> To include Addition (+), Subtraction (-), and Multiplication (√ó), use:</p>                     <div class="word-bubble">                         <code>operators=PL,MI,AS</code>                     </div>                     <h3>üìö Complete Example URL</h3>                     <p>Combining all parameters, here's how a complete URL looks:</p>                     <div class="word-bubble">                         <code>https://www.ez42.live/NewCalculusOperators-2.html?min=500&amp;max=2000&amp;operators=PL,MI,AS</code>                     </div>                     <p>This URL sets:</p>                     <ul>                         <li><strong>Minimum Number:</strong> 500</li>                         <li><strong>Maximum Number:</strong> 2000</li>                         <li><strong>Operators Enabled:</strong> Addition (+), Subtraction (-), Multiplication (√ó)</li>                     </ul>                 </section>                 <!-- Troubleshooting Section -->                 <section id="troubleshooting">                     <h2>üîç Troubleshooting Tips</h2>                                         <div class="tooltip">                         <b>1. Incorrect Operator Codes</b>                         <span class="tooltiptext">Ensure you're using the correct codes: PL, MI, AS, DE.</span>                     </div>                     <p>If your operators aren't activating correctly, double-check the codes you've used in the URL.</p>                                         <div class="tooltip">                         <b>2. URL Formatting</b>                         <span class="tooltiptext">Parameters should be separated by ampersands (&amp;).</span>                     </div>                     <p>Ensure each parameter is separated by an ampersand (<code>&amp;</code>) and there are no spaces. For example:</p>                     <div class="word-bubble">                         <code>https://www.ez42.live/NewCalculusOperators-2.html?min=500&amp;max=2000&amp;operators=PL,MI,AS</code>                     </div>                     <div class="tooltip">                         <b>3. Default Settings</b>                         <span class="tooltiptext">If something isn't working, try resetting to default.</span>                     </div>                     <p>If you're experiencing issues, try using a basic URL without additional parameters to reset to default settings:</p>                     <div class="word-bubble">                         <code>https://www.ez42.live/NewCalculusOperators-2.html</code>                     </div>                                         <div class="tooltip">                         <b>4. Using Special Characters</b>                         <span class="tooltiptext">With custom codes, you typically don't need to worry about encoding.</span>                     </div>                     <p>Our custom codes (PL, MI, AS, DE) eliminate the need for URL encoding. Simply use the codes as shown in the examples above.</p>                 </section>                 <!-- Summary Section -->                 <section id="summary">                     <h2>üìñ Summary</h2>                     <p>By customizing the URL parameters, you can tailor the math exercises to better suit your learning needs. Whether you want to focus on specific operations or adjust the difficulty by changing the number range, these simple tweaks can enhance your practice sessions.</p>                 </section>                 <!-- Additional Help Section -->                 <section id="additional-help">                     <h2>‚ùì Need More Help?</h2>                     <p>If you have any questions or need further assistance, don't hesitate to reach out to your instructor or the support team at <a href="mailto:support@ez42.live">support@ez42.live</a>.</p>                 </section>                 <!-- Footer -->                 <div class="footer">                     <p>&copy; 2024 EZ42 LIVE. All rights reserved.</p>                 </div>             </div>         </div>     </div>'`,
            'Practice': `
                <div id="stage-number" class="stage-number">Stage 1 of ${stageCount}</div>
                <div class="progress-bar-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <div id="attempts">Attempts: 0</div>
                <!-- Include your game HTML here -->
                <div class="game-area">
                    <div class="options">
                        <div class="option-item">
                            <label for="min-range">Minimum number:</label>
                            <input type="number" id="min-range" min="0" max="9999" value="0" oninput="adjustMaxRange()">
                        </div>
                        <div class="option-item">
                            <label for="max-range">Maximum number:</label>
                            <input type="number" id="max-range" min="1" max="9999" value="20" oninput="validateMaxRange(this)">
                        </div>
                        <div class="operator-container">
                            <label>Operators:</label>
                            <button class="operator-btn selected" data-op="+">+</button>
                            <button class="operator-btn selected" data-op="-">-</button>
                            <button class="operator-btn" data-op="*">√ó</button>
                            <button class="operator-btn" data-op="/">√∑</button>
                        </div>
                        <button class="generate-btn" onclick="generateExercises()">Generate</button>
                    </div>
                    <div class="exercise-grid" id="exerciseGrid">
                        <!-- Exercises will be dynamically inserted here -->
                    </div>
                    <div class="cloud" id="answerCloud">
                        <!-- Answers will be dynamically inserted here -->
                    </div>
                    <div class="buttons">
                        <button class="check-btn" onclick="checkAllAnswers()">Check Answers üéâ</button>
                    </div>
                </div>
            `
        };

        // Add the Set to track generated exercises
        let generatedExercisesSet = new Set();

        // Function to parse URL parameters and set input values
        function setInputsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const minParam = urlParams.get('min');
            const maxParam = urlParams.get('max');
            const operatorsParam = urlParams.get('operators');

            let min = parseInt(minParam, 10);
            let max = parseInt(maxParam, 10);
            let operators = [];

            const minRangeInput = document.getElementById('min-range');
            const maxRangeInput = document.getElementById('max-range');
            const operatorButtons = document.querySelectorAll('.operator-btn');

            // Validate and set min
            if (!isNaN(min) && min >= 0) {
                minRangeInput.value = min;
            }

            // Validate and set max
            if (!isNaN(max) && max > 0 && max < 10000) {
                // Ensure max is greater than current min
                const currentMin = parseInt(minRangeInput.value, 10);
                if (max > currentMin) {
                    maxRangeInput.value = max;
                }
            }

            // Validate and set operators
            if (operatorsParam) {
                // Decode the operators parameter to handle URL-encoded characters
                // Custom codes: AS=*, PL=+, MI=-, DE=/
                const codeMap = {
                    'AS': '*',
                    'PL': '+',
                    'MI': '-',
                    'DE': '/'
                };
                operators = operatorsParam
                    .split(',')
                    .map(code => code.trim().toUpperCase())
                    .map(code => codeMap[code])
                    .filter(op => ['+', '-', '*', '/'].includes(op));
            }

            if (operators.length > 0) {
                // Set operator buttons based on URL parameters
                operatorButtons.forEach(btn => {
                    const op = btn.getAttribute('data-op');
                    if (operators.includes(op)) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            } else {
                // Default to '+' and '-' if no operators are specified
                operatorButtons.forEach(btn => {
                    const op = btn.getAttribute('data-op');
                    if (op === '+' || op === '-') {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }
        }

        function adjustMaxRange() {
            const minRange = parseInt(document.getElementById('min-range').value, 10);
            const maxRangeInput = document.getElementById('max-range');

            // Update the min attribute of maxRangeInput to be minRange + 1 to ensure max > min
            maxRangeInput.min = minRange + 1;

            // If current max is less than or equal to min, adjust it
            let currentMax = parseInt(maxRangeInput.value, 10);
            if (currentMax <= minRange) {
                maxRangeInput.value = minRange + 1;
            }
        }

        function validateMaxRange(element) {
            let value = parseInt(element.value, 10);

            if (isNaN(value)) {
                element.value = 1;
                return;
            }

            if (value > 9999) {
                element.value = 9999;
            } else if (value < 1) {
                element.value = 1;
            }

            // Ensure max > min
            const minRange = parseInt(document.getElementById('min-range').value, 10);
            if (value <= minRange) {
                element.value = minRange + 1;
            }
        }

        function setQuizExpansion(allow) {
            allowQuizExpansion = allow;
            adjustLayout();
        }

        function adjustLayout() {
            const wrapper = document.querySelector('.content-wrapper');
            const quizContainer = document.getElementById('quizContainer');
            const sidePanel1 = document.getElementById('sidePanel1');

            const isPanel1Visible = window.getComputedStyle(sidePanel1).display !== 'none';

            wrapper.style.justifyContent = 'space-between';

            if (isPanel1Visible) {
                sidePanel1.style.flex = '0 0 calc(20% - 0.5rem)';
                sidePanel1.style.maxWidth = 'calc(20% - 0.5rem)';
                quizContainer.style.flex = '1';
            } else {
                quizContainer.style.flex = '1';
                wrapper.style.justifyContent = 'center';
            }

            [sidePanel1, quizContainer].forEach(el => {
                el.style.display = 'block';
            });
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            adjustLayout();
        }

        function updateSwitcherLayout() {
            const switchElement = document.getElementById('multiStateSwitch');
            const labels = switchElement.querySelectorAll('.switch-label');
            const handle = switchElement.querySelector('.switch-handle');

            labels.forEach(label => {
                label.style.flex = 'none';
                label.style.padding = '0 20px';
            });

            const activeLabel = switchElement.querySelector('.switch-label.active');
            if (activeLabel) {
                const switchRect = switchElement.getBoundingClientRect();
                const labelRect = activeLabel.getBoundingClientRect();

                handle.style.left = `${labelRect.left - switchRect.left}px`;
                handle.style.width = `${labelRect.width}px`;
            }

            switchElement.style.width = 'auto';
        }

        function switchTab(index) {
            const switchElement = document.getElementById('multiStateSwitch');
            const labels = switchElement.querySelectorAll('.switch-label');
            const activeStates = Array.from(labels).map(label => label.textContent);

            labels.forEach((label, i) => {
                label.classList.toggle('active', i === index);
            });

            updateSwitcherLayout();
            showContent(activeStates[index]);

            adjustLayout();
        }

        function showContent(state) {
            const tabContent = document.getElementById('tabContent');
            tabContent.innerHTML = stateContents[state] || '';

            if (state === 'Practice') {
                // After inserting the Practice content into the DOM, set the inputs from URL
                setInputsFromURL();

                // Initialize the game
                generateExercises();
                updateProgressBar();
                updateStageNumber();
                document.getElementById("attempts").textContent = `Attempts: ${attempts}`;
                // Toggle operator buttons
                document.querySelectorAll('.operator-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('selected');
                    });
                });
            }
        }

        function initializeSwitch() {
            const switchElement = document.getElementById('multiStateSwitch');
            const labelsContainer = switchElement.querySelector('.switch-labels');
            const switchContainer = document.getElementById('switchContainer');

            const activeStates = Object.keys(stateContents).filter(state => stateContents[state].trim() !== '');

            if (activeStates.length <= 1) {
                switchContainer.style.display = 'none';
                if (activeStates.length === 1) {
                    showContent(activeStates[0]);
                }
                return;
            }

            switchContainer.style.display = 'flex';

            activeStates.forEach((state, index) => {
                const label = document.createElement('div');
                label.className = 'switch-label';
                label.textContent = state;
                label.addEventListener('click', () => switchTab(index));
                labelsContainer.appendChild(label);
            });

            const defaultTab = manuallySetDefaultTab !== null && manuallySetDefaultTab < activeStates.length
                ? manuallySetDefaultTab
                : 0;

            switchTab(defaultTab);
        }

        function updateProgressBar() {
            const progressBar = document.getElementById("progress-bar");
            const completedStages = currentStage;
            const progress = (completedStages / stageCount) * 100;
            const roundedProgress = Math.min(100, Math.max(0, Math.round(progress)));
            progressBar.style.width = `${roundedProgress}%`;
            progressBar.textContent = roundedProgress > 0 ? `${roundedProgress}%` : '';
        }

        function updateStageNumber() {
            const stageElement = document.getElementById("stage-number");
            stageElement.textContent = `Stage ${currentStage + 1} of ${stageCount}`;
        }

        // Fisher-Yates Shuffle Algorithm
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Updated generateExercises function to prevent duplicates
        function generateExercises() {
            const minRange = parseInt(document.getElementById('min-range').value);
            const maxRange = parseInt(document.getElementById('max-range').value);
            const operators = Array.from(document.querySelectorAll('.operator-btn.selected'))
                .map(btn => btn.getAttribute('data-op'));

            if (operators.length === 0) {
                alert("Please select at least one operator.");
                return;
            }

            generatedExercisesSet.clear(); // Reset the Set at the start of each stage

            const exercises = [];
            const maxExercises = 12;
            const maxTotalAttempts = 1000; // Prevent infinite loops

            let totalAttempts = 0;

            while (exercises.length < maxExercises && totalAttempts < maxTotalAttempts) {
                let exercise = generateValidExercise(minRange, maxRange, operators);
                totalAttempts++;

                if (!generatedExercisesSet.has(exercise.key)) {
                    exercises.push(exercise.exercise);
                    generatedExercisesSet.add(exercise.key);
                }
            }

            if (exercises.length < maxExercises) {
                console.warn(`Only generated ${exercises.length} unique exercises after ${totalAttempts} attempts.`);
            }

            displayExercises(exercises);
        }

        // Updated generateValidExercise function to return a unique key
        function generateValidExercise(minRange, maxRange, operators) {
            const operator = operators[Math.floor(Math.random() * operators.length)];
            let num1, num2, answer;
            let attempts = 0;
            const maxAttempts = 1000;

            do {
                attempts++;
                switch (operator) {
                    case '+':
                        num1 = Math.floor(Math.random() * (maxRange - minRange + 1)) + minRange;
                        num2 = Math.floor(Math.random() * (maxRange - minRange + 1)) + minRange;
                        answer = num1 + num2;
                        break;
                    case '-':
                        num1 = Math.floor(Math.random() * (maxRange - minRange + 1)) + minRange;
                        num2 = Math.floor(Math.random() * (num1 - minRange + 1)) + minRange;
                        answer = num1 - num2;
                        break;
                    case '*':
                        num1 = Math.floor(Math.random() * (Math.sqrt(maxRange) - 1)) + 2;
                        num2 = Math.floor(Math.random() * (Math.floor(maxRange / num1))) + 1;
                        answer = num1 * num2;
                        break;
                    case '/':
                        num2 = Math.floor(Math.random() * (Math.sqrt(maxRange) - 1)) + 2;
                        answer = Math.floor(Math.random() * Math.floor(maxRange / num2)) + 1;
                        num1 = answer * num2;
                        break;
                }
            } while ((answer < minRange || answer > maxRange) && attempts < maxAttempts);

            if (attempts >= maxAttempts) {
                num1 = minRange;
                num2 = 0;
                answer = minRange;
            }

            // Create a unique key for the exercise
            // For commutative operations like addition and multiplication, sort the numbers to avoid duplicates like 2+3 and 3+2
            let key;
            if (operator === '+' || operator === '*') {
                key = `${operator}${Math.min(num1, num2)}_${Math.max(num1, num2)}`;
            } else {
                key = `${operator}${num1}_${num2}`;
            }

            return {
                key: key, // Unique key for the exercise
                exercise: {
                    id: Math.random().toString(36).substr(2, 9),
                    fraction1: { numerator: num1, denominator: 1 },
                    fraction2: { numerator: num2, denominator: 1 },
                    operator: operator,
                    answer: { wholeNumber: answer, numerator: 0, denominator: 1 }
                }
            };
        }

        function displayExercises(exercises) {
            const grid = document.getElementById('exerciseGrid');
            grid.innerHTML = exercises.map(createExerciseHTML).join('');

            const answerCloud = document.getElementById('answerCloud');
            const answers = exercises.map(ex => ex.answer);
            const shuffledAnswers = [...answers];
            shuffleArray(shuffledAnswers); // Use Fisher-Yates shuffle
            answerCloud.innerHTML = shuffledAnswers.map((answer, index) => createAnswerHTML(answer, index)).join('');
        }

        function createExerciseHTML(exercise) {
            return `
                <div class="exercise" id="exercise-${exercise.id}" data-answer='${JSON.stringify(exercise.answer)}'>
                    ${createFractionHTML(exercise.fraction1)}
                    <span class="operator">${exercise.operator}</span>
                    ${createFractionHTML(exercise.fraction2)}
                    <span class="operator">=</span>
                    <div class="answer-area" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                    <div class="feedback"></div>
                </div>
            `;
        }

        function createFractionHTML(fraction) {
            if (fraction.denominator === 1) {
                return `<span class="whole-number">${fraction.numerator}</span>`;
            } else {
                return `<span class="fraction"><span class="numerator">${fraction.numerator}</span><span class="denominator">${fraction.denominator}</span></span>`;
            }
        }

        function createAnswerHTML(answer, index) {
            let answerHTML;
            if (answer.denominator === 1) {
                answerHTML = `<span class="whole-number">${answer.wholeNumber}</span>`;
            } else {
                answerHTML = `
                    ${answer.wholeNumber ? `<span class="whole-number">${answer.wholeNumber}</span>` : ''}
                    <span class="fraction">
                        <span class="numerator">${answer.numerator}</span>
                        <span class="denominator">${answer.denominator}</span>
                    </span>
                `;
            }
            return `
                <div class="answer" id="answer-${index}" draggable="true" ondragstart="drag(event)" data-answer='${JSON.stringify(answer)}'>
                    ${answerHTML}
                </div>
            `;
        }

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);

            // Determine the drop target
            let dropTarget = ev.target;

            // If the drop target isn't the answer-area itself, find the parent
            if (!dropTarget.classList.contains('answer-area')) {
                dropTarget = dropTarget.closest('.answer-area');
            }

            if (dropTarget) {
                if (dropTarget.firstChild) {
                    document.getElementById('answerCloud').appendChild(dropTarget.firstChild);
                }
                dropTarget.appendChild(draggedElement);
            }
        }

        function checkAllAnswers() {
            let correctAnswers = 0;
            const exercises = document.querySelectorAll('.exercise');

            exercises.forEach(exercise => {
                const answerArea = exercise.querySelector('.answer-area');
                const answerElement = answerArea.firstChild;
                const feedbackElement = exercise.querySelector('.feedback');

                if (answerElement) {
                    const givenAnswer = JSON.parse(answerElement.getAttribute('data-answer'));
                    const correctAnswer = JSON.parse(exercise.getAttribute('data-answer'));

                    if (JSON.stringify(givenAnswer) === JSON.stringify(correctAnswer)) {
                        correctAnswers++;
                        answerArea.style.backgroundColor = '#c8e6c9'; // Pale green
                        feedbackElement.textContent = 'üòÉ';
                        feedbackElement.className = 'feedback correct';
                    } else {
                        answerArea.style.backgroundColor = '#ffcdd2'; // Light red
                        feedbackElement.textContent = '‚ùå';
                        feedbackElement.className = 'feedback incorrect';
                    }
                } else {
                    answerArea.style.backgroundColor = '#f0f0f0'; // Default background
                    feedbackElement.textContent = '';
                    feedbackElement.className = 'feedback';
                }
            });

            attempts++;
            document.getElementById("attempts").textContent = `Attempts: ${attempts}`;

            if (correctAnswers === exercises.length) {
                // Stage is completed
                addAnimalsToFarm(exercises.length); // Add animals
                if (currentStage < stageCount - 1) {
                    singleStageConfetti();
                    showEncouragingPopup(correctAnswers, exercises.length, true);
                    currentStage++; // Increment stage
                    updateProgressBar();
                    updateStageNumber();
                    setTimeout(() => {
                        attempts = 0;
                        generateExercises();
                        document.getElementById("attempts").textContent = `Attempts: ${attempts}`;
                    }, 1500);
                } else {
                    // Final stage completed
                    currentStage++;
                    updateProgressBar(); // This will now show 100%
                    allStagesConfetti();
                    showModal("Congratulations! You've completed all stages.");
                }
            } else {
                showEncouragingPopup(correctAnswers, exercises.length, false);
                if (attempts >= 10) {
                    showModal("You've reached the maximum number of attempts. Try again!");
                }
            }

            scrollToTop();
        }

        function showEncouragingPopup(correctCount, totalQuestions, isStageComplete) {
            const incorrectCount = totalQuestions - correctCount;
            let message = `You got ${correctCount} correct and ${incorrectCount} incorrect.`;

            // Add encouraging message based on performance
            if (correctCount === totalQuestions) {
                message += " Perfect score!";
            } else if (correctCount >= Math.ceil(totalQuestions * 0.7)) {
                message += " Great job! You're really getting the hang of this!";
            } else if (correctCount >= Math.ceil(totalQuestions * 0.5)) {
                message += " Good effort! Keep practicing and you'll improve in no time!";
            } else {
                message += " Don't give up! Every attempt helps you learn. Try again!";
            }

            // Add stage completion message if applicable
            if (isStageComplete) {
                message += "\n\nYou've completed this stage. Moving to the next stage.";
            }

            showModal(message);
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showModal(message) {
            const modal = document.getElementById("quizModal");
            const modalMessage = document.getElementById("modalMessage");
            const modalButton = document.getElementById("modalButton");
            const modalClose = document.getElementsByClassName("modal-quiz-close")[0];

            modalMessage.textContent = message;
            modal.style.display = "block";

            modalButton.onclick = function() {
                modal.style.display = "none";
            }

            modalClose.onclick = function() {
                modal.style.display = "none";
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        }

        function singleStageConfetti() {
            function randomInRange(min, max) {
                return Math.random() * (max - min) + min;
            }
            confetti({
                angle: randomInRange(55, 125),
                spread: randomInRange(50, 70),
                particleCount: randomInRange(50, 100),
                origin: { y: 0.6 },
            });
        }

        function allStagesConfetti() {
            const defaults = {
                spread: 360,
                ticks: 50,
                gravity: 0,
                decay: 0.94,
                startVelocity: 30,
                shapes: ["star"],
                colors: ["#FFE400", "#FFBD00", "#E89400", "#FFCA6C", "#FDFFB8"],
            };
            function shoot() {
                confetti({
                    ...defaults,
                    particleCount: 40,
                    scalar: 1.2,
                    shapes: ["star"],
                });
                confetti({
                    ...defaults,
                    particleCount: 10,
                    scalar: 0.75,
                    shapes: ["circle"],
                });
            }
            setTimeout(shoot, 0);
            setTimeout(shoot, 100);
            setTimeout(shoot, 200);
        }

        let farmAnimals = [];
        const animals = [
            "üêâ", "üêª", "ü¶ó", "ü¶Å", "üêî", "ü¶Ç", "üêü", "üê£", "üêØ", "ü¶°",
            "üê∞", "üêç", "ü¶Ö", "üêà", "ü¶à", "ü¶ú", "ü¶õ", "üêÄ", "üêë",
            "üêÆ", "ü¶á", "üêá", "ü¶ñ", "ü¶Ä", "ü¶é", "üêÉ", "üê°", "üê§",
            "üê™", "ü¶•", "üêõ", "üêÖ", "üê•", "üê±", "üê∫", "üêï", "ü¶©", "üêä",
            "üêñ", "üê¢", "üï∑", "ü¶ï", "ü¶å", "üêÅ", "ü¶®", "ü¶ò", "üêµ",
            "ü¶ë", "üêã", "ü¶ì", "ü¶í", "üê≤", "ü¶Ü", "ü¶â", "üê∂", "üêÑ", "ü¶ü",
            "ü¶É", "ü¶ß", "ü¶è", "üêô", "üêø", "ü¶¢", "üêú", "üê¶", "üêû",
            "ü¶ê", "ü¶î", "üêº", "ü¶Ñ", "ü¶û", "üê´", "üê≠", "üêÜ", "ü¶ù",
            "üê†", "ü¶ö", "üê¥", "üêè", "ü¶Æ", "üêê", "üêπ", "üêé", "ü¶ã", "üê≥",
            "üê®", "üêÇ", "ü¶ç", "ü¶ô", "üê¨", "ü¶¶", "ü¶ä", "üêå", "üêì", "üêß",
            "üê∑", "üê©", "üêò", "üê∏", "üêù"
        ];

        function addAnimalsToFarm(count) {
            const animalFarm = document.getElementById('animalFarm');
            let availableAnimals = animals.filter(animal => !farmAnimals.includes(animal));

            for (let i = 0; i < count; i++) {
                if (availableAnimals.length === 0) {
                    break;
                }

                const randomIndex = Math.floor(Math.random() * availableAnimals.length);
                const chosenAnimal = availableAnimals[randomIndex];

                const animalElement = document.createElement('li');
                animalElement.textContent = chosenAnimal;
                animalFarm.appendChild(animalElement);

                farmAnimals.push(chosenAnimal);
                availableAnimals.splice(randomIndex, 1);
            }
        }

        window.addEventListener('load', () => {
            initializeSwitch();
            adjustLayout();
        });

        window.addEventListener('resize', adjustLayout);

        // Load the copyright content from the external URL and insert it into the div
        fetch('http://ez42.live/global/copyright.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('copyright-container').innerHTML = data;
            })
            .catch(error => console.error('Error loading copyright:', error));
    </script>
</body>
</html>
